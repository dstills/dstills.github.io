"use strict";
(self["webpackChunksynview"] = self["webpackChunksynview"] || []).push([["vendors-node_modules_esri_calcite-components_dist_components_calcite-tree_js"],{

/***/ "./node_modules/@esri/calcite-components/dist/components/calcite-tree.js":
/*!*******************************************************************************!*\
  !*** ./node_modules/@esri/calcite-components/dist/components/calcite-tree.js ***!
  \*******************************************************************************/
/***/ ((__unused_webpack___webpack_module__, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   CalciteTree: () => (/* binding */ CalciteTree),
/* harmony export */   defineCustomElement: () => (/* binding */ defineCustomElement)
/* harmony export */ });
/* harmony import */ var _stencil_core_internal_client_index_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! @stencil/core/internal/client/index.js */ "./node_modules/@stencil/core/internal/client/index.js");
/* harmony import */ var _dom_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./dom.js */ "./node_modules/@esri/calcite-components/dist/components/dom.js");
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * See https://github.com/Esri/calcite-design-system/blob/main/LICENSE.md for details.
 * v1.7.0
 */



function isTreeItem(element) {
  return element?.tagName === "CALCITE-TREE-ITEM";
}
function getTraversableItems(root) {
  return Array.from(root.querySelectorAll("calcite-tree-item:not([disabled])")).filter((item) => {
    let currentItem = item;
    while (currentItem !== root && currentItem !== undefined) {
      const parent = currentItem.parentElement;
      const traversable = !isTreeItem(parent) || !parent.hasChildren || parent.expanded;
      if (!traversable) {
        return false;
      }
      currentItem = currentItem.parentElement;
    }
    return true;
  });
}

const treeCss = ":host{display:block}:host(:focus){outline:2px solid transparent;outline-offset:2px}:host([hidden]){display:none}[hidden]{display:none}";

const Tree = /*@__PURE__*/ (0,_stencil_core_internal_client_index_js__WEBPACK_IMPORTED_MODULE_1__.proxyCustomElement)(class extends _stencil_core_internal_client_index_js__WEBPACK_IMPORTED_MODULE_1__.HTMLElement {
  constructor() {
    super();
    this.__registerHost();
    this.__attachShadow();
    this.calciteTreeSelect = (0,_stencil_core_internal_client_index_js__WEBPACK_IMPORTED_MODULE_1__.createEvent)(this, "calciteTreeSelect", 6);
    this.keyDownHandler = (event) => {
      if (this.child) {
        return;
      }
      const root = this.el;
      const target = event.target;
      const supportedKeys = ["ArrowRight", "ArrowDown", "ArrowLeft", "ArrowUp", "Home", "End", "Tab"];
      if (!(isTreeItem(target) && this.el.contains(target)) || !supportedKeys.includes(event.key)) {
        return;
      }
      const traversableItems = getTraversableItems(root);
      if (event.key === "Tab") {
        // root tabindex will be restored when blurred/focused
        traversableItems.forEach((item) => (item.tabIndex = -1));
        return;
      }
      if (event.key === "ArrowDown") {
        const currentItemIndex = traversableItems.indexOf(target);
        const nextItem = traversableItems[currentItemIndex + 1];
        nextItem?.focus();
        event.preventDefault();
        return;
      }
      if (event.key === "ArrowUp") {
        const currentItemIndex = traversableItems.indexOf(target);
        const previousItem = traversableItems[currentItemIndex - 1];
        previousItem?.focus();
        event.preventDefault();
        return;
      }
      if (event.key === "ArrowLeft") {
        if (target.hasChildren && target.expanded) {
          target.expanded = false;
          event.preventDefault();
          return;
        }
        const rootToItemPath = traversableItems.slice(0, traversableItems.indexOf(target)).reverse();
        const parentItem = rootToItemPath.find((item) => item.depth === target.depth - 1);
        parentItem?.focus();
        event.preventDefault();
        return;
      }
      if (event.key === "ArrowRight") {
        if (!target.disabled && target.hasChildren) {
          if (!target.expanded) {
            target.expanded = true;
            event.preventDefault();
          }
          else {
            const currentItemIndex = traversableItems.indexOf(target);
            const nextItem = traversableItems[currentItemIndex + 1];
            nextItem?.focus();
            event.preventDefault();
          }
        }
        return;
      }
      if (event.key === "Home") {
        const firstNode = traversableItems.shift();
        if (firstNode) {
          firstNode.focus();
          event.preventDefault();
        }
        return;
      }
      if (event.key === "End") {
        const lastNode = traversableItems.pop();
        if (lastNode) {
          lastNode.focus();
          event.preventDefault();
        }
        return;
      }
    };
    this.lines = false;
    this.child = undefined;
    this.scale = "m";
    this.selectionMode = "single";
    this.selectedItems = [];
  }
  //--------------------------------------------------------------------------
  //
  //  Lifecycle
  //
  //--------------------------------------------------------------------------
  componentWillRender() {
    const parent = this.el.parentElement?.closest("calcite-tree");
    this.lines = parent ? parent.lines : this.lines;
    this.scale = parent ? parent.scale : this.scale;
    this.selectionMode = parent ? parent.selectionMode : this.selectionMode;
    this.child = !!parent;
  }
  render() {
    return ((0,_stencil_core_internal_client_index_js__WEBPACK_IMPORTED_MODULE_1__.h)(_stencil_core_internal_client_index_js__WEBPACK_IMPORTED_MODULE_1__.Host, { "aria-multiselectable": this.child
        ? undefined
        : (this.selectionMode === "multiple" || this.selectionMode === "multichildren").toString(), onKeyDown: this.keyDownHandler, role: !this.child ? "tree" : undefined, tabIndex: this.getRootTabIndex() }, (0,_stencil_core_internal_client_index_js__WEBPACK_IMPORTED_MODULE_1__.h)("slot", null)));
  }
  //--------------------------------------------------------------------------
  //
  //  Event Listeners
  //
  //--------------------------------------------------------------------------
  onFocus() {
    if (!this.child) {
      const focusTarget = this.el.querySelector("calcite-tree-item[selected]:not([disabled])") || this.el.querySelector("calcite-tree-item:not([disabled])");
      (0,_dom_js__WEBPACK_IMPORTED_MODULE_0__.k)(focusTarget);
    }
  }
  onFocusIn(event) {
    const focusedFromRootOrOutsideTree = event.relatedTarget === this.el || !this.el.contains(event.relatedTarget);
    if (focusedFromRootOrOutsideTree) {
      // gives user the ability to tab into external elements (modifying tabindex property will not work in firefox)
      this.el.removeAttribute("tabindex");
    }
  }
  onFocusOut(event) {
    const willFocusOutsideTree = !this.el.contains(event.relatedTarget);
    if (willFocusOutsideTree) {
      this.el.tabIndex = this.getRootTabIndex();
    }
  }
  onClick(event) {
    const target = event.target;
    const childItems = (0,_dom_js__WEBPACK_IMPORTED_MODULE_0__.o)(target.querySelectorAll("calcite-tree-item"));
    if (this.child) {
      return;
    }
    if (!this.child) {
      event.preventDefault();
      event.stopPropagation();
    }
    if (this.selectionMode === "ancestors" && !this.child) {
      this.updateAncestorTree(event);
      return;
    }
    const isNoneSelectionMode = this.selectionMode === "none";
    const shouldSelect = this.selectionMode !== null &&
      (!target.hasChildren ||
        (target.hasChildren &&
          (this.selectionMode === "children" || this.selectionMode === "multichildren")));
    const shouldDeselectAllChildren = this.selectionMode === "multichildren" && target.hasChildren;
    const shouldModifyToCurrentSelection = !isNoneSelectionMode &&
      event.detail.modifyCurrentSelection &&
      (this.selectionMode === "multiple" || this.selectionMode === "multichildren");
    const shouldClearCurrentSelection = !shouldModifyToCurrentSelection &&
      (((this.selectionMode === "single" || this.selectionMode === "multiple") &&
        childItems.length <= 0) ||
        this.selectionMode === "children" ||
        this.selectionMode === "multichildren");
    const shouldUpdateExpand = ["children", "multichildren"].includes(this.selectionMode) ||
      (["single", "multiple"].includes(this.selectionMode) &&
        target.hasChildren &&
        !event.detail.forceToggle);
    if (!this.child) {
      const targetItems = [];
      if (shouldSelect) {
        targetItems.push(target);
      }
      if (shouldClearCurrentSelection) {
        const selectedItems = (0,_dom_js__WEBPACK_IMPORTED_MODULE_0__.o)(this.el.querySelectorAll("calcite-tree-item[selected]"));
        selectedItems.forEach((treeItem) => {
          if (!targetItems.includes(treeItem)) {
            treeItem.selected = false;
          }
        });
      }
      if (shouldUpdateExpand) {
        if (["single", "multiple"].includes(this.selectionMode)) {
          target.expanded = !target.expanded;
        }
        else if (this.selectionMode === "multichildren") {
          target.expanded = !target.selected;
        }
        else if (this.selectionMode === "children") {
          target.expanded = target.selected ? !target.expanded : true;
        }
      }
      if (shouldDeselectAllChildren) {
        childItems.forEach((item) => {
          item.selected = false;
          if (item.hasChildren) {
            item.expanded = false;
          }
        });
      }
      if (shouldModifyToCurrentSelection) {
        window.getSelection().removeAllRanges();
      }
      if ((shouldModifyToCurrentSelection && target.selected) || event.detail.forceToggle) {
        targetItems.forEach((treeItem) => {
          if (!treeItem.disabled) {
            treeItem.selected = false;
          }
        });
      }
      else if (!isNoneSelectionMode) {
        targetItems.forEach((treeItem) => {
          if (!treeItem.disabled) {
            treeItem.selected = true;
          }
        });
      }
    }
    this.selectedItems = isNoneSelectionMode
      ? [target]
      : (0,_dom_js__WEBPACK_IMPORTED_MODULE_0__.o)(this.el.querySelectorAll("calcite-tree-item")).filter((i) => i.selected);
    this.calciteTreeSelect.emit();
    event.stopPropagation();
  }
  updateAncestorTree(event) {
    const item = event.target;
    const updateItem = event.detail.updateItem;
    if (item.disabled || (item.indeterminate && !updateItem)) {
      return;
    }
    const ancestors = [];
    let parent = item.parentElement.closest("calcite-tree-item");
    while (parent) {
      ancestors.push(parent);
      parent = parent.parentElement.closest("calcite-tree-item");
    }
    const childItems = Array.from(item.querySelectorAll("calcite-tree-item:not([disabled])"));
    const childItemsWithNoChildren = childItems.filter((child) => !child.hasChildren);
    const childItemsWithChildren = childItems.filter((child) => child.hasChildren);
    let futureSelected;
    if (updateItem) {
      futureSelected = item.hasChildren ? !(item.selected || item.indeterminate) : !item.selected;
    }
    else {
      futureSelected = item.selected;
    }
    childItemsWithNoChildren.forEach((el) => {
      el.selected = futureSelected;
      el.indeterminate = false;
    });
    function updateItemState(childItems, item) {
      const selected = childItems.filter((child) => child.selected);
      const unselected = childItems.filter((child) => !child.selected);
      item.selected = selected.length === childItems.length;
      item.indeterminate = selected.length > 0 && unselected.length > 0;
    }
    childItemsWithChildren.reverse().forEach((el) => {
      const directChildItems = Array.from(el.querySelectorAll(":scope > calcite-tree > calcite-tree-item"));
      updateItemState(directChildItems, el);
    });
    if (updateItem) {
      if (item.hasChildren) {
        updateItemState(childItems, item);
      }
      else {
        item.selected = futureSelected;
        item.indeterminate = false;
      }
    }
    ancestors.forEach((ancestor) => {
      const descendants = (0,_dom_js__WEBPACK_IMPORTED_MODULE_0__.o)(ancestor.querySelectorAll("calcite-tree-item"));
      const activeDescendants = descendants.filter((el) => el.selected);
      if (activeDescendants.length === 0) {
        ancestor.selected = false;
        ancestor.indeterminate = false;
        return;
      }
      const indeterminate = activeDescendants.length < descendants.length;
      ancestor.indeterminate = indeterminate;
      ancestor.selected = !indeterminate;
    });
    this.selectedItems = (0,_dom_js__WEBPACK_IMPORTED_MODULE_0__.o)(this.el.querySelectorAll("calcite-tree-item")).filter((i) => i.selected);
    if (updateItem) {
      this.calciteTreeSelect.emit();
    }
  }
  // --------------------------------------------------------------------------
  //
  //  Private Methods
  //
  //--------------------------------------------------------------------------
  getRootTabIndex() {
    return !this.child ? 0 : -1;
  }
  get el() { return this; }
  static get style() { return treeCss; }
}, [1, "calcite-tree", {
    "lines": [1540],
    "child": [1540],
    "scale": [1537],
    "selectionMode": [1537, "selection-mode"],
    "selectedItems": [1040]
  }, [[0, "focus", "onFocus"], [0, "focusin", "onFocusIn"], [0, "focusout", "onFocusOut"], [0, "calciteInternalTreeItemSelect", "onClick"]]]);
function defineCustomElement$1() {
  if (typeof customElements === "undefined") {
    return;
  }
  const components = ["calcite-tree"];
  components.forEach(tagName => { switch (tagName) {
    case "calcite-tree":
      if (!customElements.get(tagName)) {
        customElements.define(tagName, Tree);
      }
      break;
  } });
}
defineCustomElement$1();

const CalciteTree = Tree;
const defineCustomElement = defineCustomElement$1;




/***/ })

}]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmVuZG9ycy1ub2RlX21vZHVsZXNfZXNyaV9jYWxjaXRlLWNvbXBvbmVudHNfZGlzdF9jb21wb25lbnRzX2NhbGNpdGUtdHJlZV9qcy5idW5kbGUuanMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7OztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDK0c7QUFDNUM7O0FBRW5FO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDs7QUFFQSx1QkFBdUIsY0FBYyxjQUFjLDhCQUE4QixtQkFBbUIsZ0JBQWdCLGFBQWEsU0FBUyxhQUFhOztBQUV2SiwyQkFBMkIsMEZBQWtCLGVBQWUsK0VBQVc7QUFDdkU7QUFDQTtBQUNBO0FBQ0E7QUFDQSw2QkFBNkIsbUZBQVc7QUFDeEM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsWUFBWSx5RUFBQyxDQUFDLHdFQUFJLElBQUk7QUFDdEI7QUFDQSw4TUFBOE0sRUFBRSx5RUFBQztBQUNqTjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxNQUFNLDBDQUFZO0FBQ2xCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx1QkFBdUIsMENBQWU7QUFDdEM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDhCQUE4QiwwQ0FBZTtBQUM3QztBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBLFFBQVEsMENBQWU7QUFDdkI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsMEJBQTBCLDBDQUFlO0FBQ3pDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTCx5QkFBeUIsMENBQWU7QUFDeEM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiLHVCQUF1QjtBQUN2QixDQUFDO0FBQ0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esa0NBQWtDO0FBQ2xDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTs7QUFFQTtBQUNBOztBQUU0QyIsInNvdXJjZXMiOlsid2VicGFjazovL3N5bnZpZXcvLi9ub2RlX21vZHVsZXMvQGVzcmkvY2FsY2l0ZS1jb21wb25lbnRzL2Rpc3QvY29tcG9uZW50cy9jYWxjaXRlLXRyZWUuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBBbGwgbWF0ZXJpYWwgY29weXJpZ2h0IEVTUkksIEFsbCBSaWdodHMgUmVzZXJ2ZWQsIHVubGVzcyBvdGhlcndpc2Ugc3BlY2lmaWVkLlxuICogU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9Fc3JpL2NhbGNpdGUtZGVzaWduLXN5c3RlbS9ibG9iL21haW4vTElDRU5TRS5tZCBmb3IgZGV0YWlscy5cbiAqIHYxLjcuMFxuICovXG5pbXBvcnQgeyBwcm94eUN1c3RvbUVsZW1lbnQsIEhUTUxFbGVtZW50LCBjcmVhdGVFdmVudCwgaCwgSG9zdCB9IGZyb20gJ0BzdGVuY2lsL2NvcmUvaW50ZXJuYWwvY2xpZW50L2luZGV4LmpzJztcbmltcG9ydCB7IGsgYXMgZm9jdXNFbGVtZW50LCBvIGFzIG5vZGVMaXN0VG9BcnJheSB9IGZyb20gJy4vZG9tLmpzJztcblxuZnVuY3Rpb24gaXNUcmVlSXRlbShlbGVtZW50KSB7XG4gIHJldHVybiBlbGVtZW50Py50YWdOYW1lID09PSBcIkNBTENJVEUtVFJFRS1JVEVNXCI7XG59XG5mdW5jdGlvbiBnZXRUcmF2ZXJzYWJsZUl0ZW1zKHJvb3QpIHtcbiAgcmV0dXJuIEFycmF5LmZyb20ocm9vdC5xdWVyeVNlbGVjdG9yQWxsKFwiY2FsY2l0ZS10cmVlLWl0ZW06bm90KFtkaXNhYmxlZF0pXCIpKS5maWx0ZXIoKGl0ZW0pID0+IHtcbiAgICBsZXQgY3VycmVudEl0ZW0gPSBpdGVtO1xuICAgIHdoaWxlIChjdXJyZW50SXRlbSAhPT0gcm9vdCAmJiBjdXJyZW50SXRlbSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBjb25zdCBwYXJlbnQgPSBjdXJyZW50SXRlbS5wYXJlbnRFbGVtZW50O1xuICAgICAgY29uc3QgdHJhdmVyc2FibGUgPSAhaXNUcmVlSXRlbShwYXJlbnQpIHx8ICFwYXJlbnQuaGFzQ2hpbGRyZW4gfHwgcGFyZW50LmV4cGFuZGVkO1xuICAgICAgaWYgKCF0cmF2ZXJzYWJsZSkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgICBjdXJyZW50SXRlbSA9IGN1cnJlbnRJdGVtLnBhcmVudEVsZW1lbnQ7XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9KTtcbn1cblxuY29uc3QgdHJlZUNzcyA9IFwiOmhvc3R7ZGlzcGxheTpibG9ja306aG9zdCg6Zm9jdXMpe291dGxpbmU6MnB4IHNvbGlkIHRyYW5zcGFyZW50O291dGxpbmUtb2Zmc2V0OjJweH06aG9zdChbaGlkZGVuXSl7ZGlzcGxheTpub25lfVtoaWRkZW5de2Rpc3BsYXk6bm9uZX1cIjtcblxuY29uc3QgVHJlZSA9IC8qQF9fUFVSRV9fKi8gcHJveHlDdXN0b21FbGVtZW50KGNsYXNzIGV4dGVuZHMgSFRNTEVsZW1lbnQge1xuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuX19yZWdpc3Rlckhvc3QoKTtcbiAgICB0aGlzLl9fYXR0YWNoU2hhZG93KCk7XG4gICAgdGhpcy5jYWxjaXRlVHJlZVNlbGVjdCA9IGNyZWF0ZUV2ZW50KHRoaXMsIFwiY2FsY2l0ZVRyZWVTZWxlY3RcIiwgNik7XG4gICAgdGhpcy5rZXlEb3duSGFuZGxlciA9IChldmVudCkgPT4ge1xuICAgICAgaWYgKHRoaXMuY2hpbGQpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgY29uc3Qgcm9vdCA9IHRoaXMuZWw7XG4gICAgICBjb25zdCB0YXJnZXQgPSBldmVudC50YXJnZXQ7XG4gICAgICBjb25zdCBzdXBwb3J0ZWRLZXlzID0gW1wiQXJyb3dSaWdodFwiLCBcIkFycm93RG93blwiLCBcIkFycm93TGVmdFwiLCBcIkFycm93VXBcIiwgXCJIb21lXCIsIFwiRW5kXCIsIFwiVGFiXCJdO1xuICAgICAgaWYgKCEoaXNUcmVlSXRlbSh0YXJnZXQpICYmIHRoaXMuZWwuY29udGFpbnModGFyZ2V0KSkgfHwgIXN1cHBvcnRlZEtleXMuaW5jbHVkZXMoZXZlbnQua2V5KSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBjb25zdCB0cmF2ZXJzYWJsZUl0ZW1zID0gZ2V0VHJhdmVyc2FibGVJdGVtcyhyb290KTtcbiAgICAgIGlmIChldmVudC5rZXkgPT09IFwiVGFiXCIpIHtcbiAgICAgICAgLy8gcm9vdCB0YWJpbmRleCB3aWxsIGJlIHJlc3RvcmVkIHdoZW4gYmx1cnJlZC9mb2N1c2VkXG4gICAgICAgIHRyYXZlcnNhYmxlSXRlbXMuZm9yRWFjaCgoaXRlbSkgPT4gKGl0ZW0udGFiSW5kZXggPSAtMSkpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBpZiAoZXZlbnQua2V5ID09PSBcIkFycm93RG93blwiKSB7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRJdGVtSW5kZXggPSB0cmF2ZXJzYWJsZUl0ZW1zLmluZGV4T2YodGFyZ2V0KTtcbiAgICAgICAgY29uc3QgbmV4dEl0ZW0gPSB0cmF2ZXJzYWJsZUl0ZW1zW2N1cnJlbnRJdGVtSW5kZXggKyAxXTtcbiAgICAgICAgbmV4dEl0ZW0/LmZvY3VzKCk7XG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGlmIChldmVudC5rZXkgPT09IFwiQXJyb3dVcFwiKSB7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRJdGVtSW5kZXggPSB0cmF2ZXJzYWJsZUl0ZW1zLmluZGV4T2YodGFyZ2V0KTtcbiAgICAgICAgY29uc3QgcHJldmlvdXNJdGVtID0gdHJhdmVyc2FibGVJdGVtc1tjdXJyZW50SXRlbUluZGV4IC0gMV07XG4gICAgICAgIHByZXZpb3VzSXRlbT8uZm9jdXMoKTtcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgaWYgKGV2ZW50LmtleSA9PT0gXCJBcnJvd0xlZnRcIikge1xuICAgICAgICBpZiAodGFyZ2V0Lmhhc0NoaWxkcmVuICYmIHRhcmdldC5leHBhbmRlZCkge1xuICAgICAgICAgIHRhcmdldC5leHBhbmRlZCA9IGZhbHNlO1xuICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHJvb3RUb0l0ZW1QYXRoID0gdHJhdmVyc2FibGVJdGVtcy5zbGljZSgwLCB0cmF2ZXJzYWJsZUl0ZW1zLmluZGV4T2YodGFyZ2V0KSkucmV2ZXJzZSgpO1xuICAgICAgICBjb25zdCBwYXJlbnRJdGVtID0gcm9vdFRvSXRlbVBhdGguZmluZCgoaXRlbSkgPT4gaXRlbS5kZXB0aCA9PT0gdGFyZ2V0LmRlcHRoIC0gMSk7XG4gICAgICAgIHBhcmVudEl0ZW0/LmZvY3VzKCk7XG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGlmIChldmVudC5rZXkgPT09IFwiQXJyb3dSaWdodFwiKSB7XG4gICAgICAgIGlmICghdGFyZ2V0LmRpc2FibGVkICYmIHRhcmdldC5oYXNDaGlsZHJlbikge1xuICAgICAgICAgIGlmICghdGFyZ2V0LmV4cGFuZGVkKSB7XG4gICAgICAgICAgICB0YXJnZXQuZXhwYW5kZWQgPSB0cnVlO1xuICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBjb25zdCBjdXJyZW50SXRlbUluZGV4ID0gdHJhdmVyc2FibGVJdGVtcy5pbmRleE9mKHRhcmdldCk7XG4gICAgICAgICAgICBjb25zdCBuZXh0SXRlbSA9IHRyYXZlcnNhYmxlSXRlbXNbY3VycmVudEl0ZW1JbmRleCArIDFdO1xuICAgICAgICAgICAgbmV4dEl0ZW0/LmZvY3VzKCk7XG4gICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBpZiAoZXZlbnQua2V5ID09PSBcIkhvbWVcIikge1xuICAgICAgICBjb25zdCBmaXJzdE5vZGUgPSB0cmF2ZXJzYWJsZUl0ZW1zLnNoaWZ0KCk7XG4gICAgICAgIGlmIChmaXJzdE5vZGUpIHtcbiAgICAgICAgICBmaXJzdE5vZGUuZm9jdXMoKTtcbiAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGlmIChldmVudC5rZXkgPT09IFwiRW5kXCIpIHtcbiAgICAgICAgY29uc3QgbGFzdE5vZGUgPSB0cmF2ZXJzYWJsZUl0ZW1zLnBvcCgpO1xuICAgICAgICBpZiAobGFzdE5vZGUpIHtcbiAgICAgICAgICBsYXN0Tm9kZS5mb2N1cygpO1xuICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH07XG4gICAgdGhpcy5saW5lcyA9IGZhbHNlO1xuICAgIHRoaXMuY2hpbGQgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5zY2FsZSA9IFwibVwiO1xuICAgIHRoaXMuc2VsZWN0aW9uTW9kZSA9IFwic2luZ2xlXCI7XG4gICAgdGhpcy5zZWxlY3RlZEl0ZW1zID0gW107XG4gIH1cbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvL1xuICAvLyAgTGlmZWN5Y2xlXG4gIC8vXG4gIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgY29tcG9uZW50V2lsbFJlbmRlcigpIHtcbiAgICBjb25zdCBwYXJlbnQgPSB0aGlzLmVsLnBhcmVudEVsZW1lbnQ/LmNsb3Nlc3QoXCJjYWxjaXRlLXRyZWVcIik7XG4gICAgdGhpcy5saW5lcyA9IHBhcmVudCA/IHBhcmVudC5saW5lcyA6IHRoaXMubGluZXM7XG4gICAgdGhpcy5zY2FsZSA9IHBhcmVudCA/IHBhcmVudC5zY2FsZSA6IHRoaXMuc2NhbGU7XG4gICAgdGhpcy5zZWxlY3Rpb25Nb2RlID0gcGFyZW50ID8gcGFyZW50LnNlbGVjdGlvbk1vZGUgOiB0aGlzLnNlbGVjdGlvbk1vZGU7XG4gICAgdGhpcy5jaGlsZCA9ICEhcGFyZW50O1xuICB9XG4gIHJlbmRlcigpIHtcbiAgICByZXR1cm4gKGgoSG9zdCwgeyBcImFyaWEtbXVsdGlzZWxlY3RhYmxlXCI6IHRoaXMuY2hpbGRcbiAgICAgICAgPyB1bmRlZmluZWRcbiAgICAgICAgOiAodGhpcy5zZWxlY3Rpb25Nb2RlID09PSBcIm11bHRpcGxlXCIgfHwgdGhpcy5zZWxlY3Rpb25Nb2RlID09PSBcIm11bHRpY2hpbGRyZW5cIikudG9TdHJpbmcoKSwgb25LZXlEb3duOiB0aGlzLmtleURvd25IYW5kbGVyLCByb2xlOiAhdGhpcy5jaGlsZCA/IFwidHJlZVwiIDogdW5kZWZpbmVkLCB0YWJJbmRleDogdGhpcy5nZXRSb290VGFiSW5kZXgoKSB9LCBoKFwic2xvdFwiLCBudWxsKSkpO1xuICB9XG4gIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy9cbiAgLy8gIEV2ZW50IExpc3RlbmVyc1xuICAvL1xuICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIG9uRm9jdXMoKSB7XG4gICAgaWYgKCF0aGlzLmNoaWxkKSB7XG4gICAgICBjb25zdCBmb2N1c1RhcmdldCA9IHRoaXMuZWwucXVlcnlTZWxlY3RvcihcImNhbGNpdGUtdHJlZS1pdGVtW3NlbGVjdGVkXTpub3QoW2Rpc2FibGVkXSlcIikgfHwgdGhpcy5lbC5xdWVyeVNlbGVjdG9yKFwiY2FsY2l0ZS10cmVlLWl0ZW06bm90KFtkaXNhYmxlZF0pXCIpO1xuICAgICAgZm9jdXNFbGVtZW50KGZvY3VzVGFyZ2V0KTtcbiAgICB9XG4gIH1cbiAgb25Gb2N1c0luKGV2ZW50KSB7XG4gICAgY29uc3QgZm9jdXNlZEZyb21Sb290T3JPdXRzaWRlVHJlZSA9IGV2ZW50LnJlbGF0ZWRUYXJnZXQgPT09IHRoaXMuZWwgfHwgIXRoaXMuZWwuY29udGFpbnMoZXZlbnQucmVsYXRlZFRhcmdldCk7XG4gICAgaWYgKGZvY3VzZWRGcm9tUm9vdE9yT3V0c2lkZVRyZWUpIHtcbiAgICAgIC8vIGdpdmVzIHVzZXIgdGhlIGFiaWxpdHkgdG8gdGFiIGludG8gZXh0ZXJuYWwgZWxlbWVudHMgKG1vZGlmeWluZyB0YWJpbmRleCBwcm9wZXJ0eSB3aWxsIG5vdCB3b3JrIGluIGZpcmVmb3gpXG4gICAgICB0aGlzLmVsLnJlbW92ZUF0dHJpYnV0ZShcInRhYmluZGV4XCIpO1xuICAgIH1cbiAgfVxuICBvbkZvY3VzT3V0KGV2ZW50KSB7XG4gICAgY29uc3Qgd2lsbEZvY3VzT3V0c2lkZVRyZWUgPSAhdGhpcy5lbC5jb250YWlucyhldmVudC5yZWxhdGVkVGFyZ2V0KTtcbiAgICBpZiAod2lsbEZvY3VzT3V0c2lkZVRyZWUpIHtcbiAgICAgIHRoaXMuZWwudGFiSW5kZXggPSB0aGlzLmdldFJvb3RUYWJJbmRleCgpO1xuICAgIH1cbiAgfVxuICBvbkNsaWNrKGV2ZW50KSB7XG4gICAgY29uc3QgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0O1xuICAgIGNvbnN0IGNoaWxkSXRlbXMgPSBub2RlTGlzdFRvQXJyYXkodGFyZ2V0LnF1ZXJ5U2VsZWN0b3JBbGwoXCJjYWxjaXRlLXRyZWUtaXRlbVwiKSk7XG4gICAgaWYgKHRoaXMuY2hpbGQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKCF0aGlzLmNoaWxkKSB7XG4gICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgfVxuICAgIGlmICh0aGlzLnNlbGVjdGlvbk1vZGUgPT09IFwiYW5jZXN0b3JzXCIgJiYgIXRoaXMuY2hpbGQpIHtcbiAgICAgIHRoaXMudXBkYXRlQW5jZXN0b3JUcmVlKGV2ZW50KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgaXNOb25lU2VsZWN0aW9uTW9kZSA9IHRoaXMuc2VsZWN0aW9uTW9kZSA9PT0gXCJub25lXCI7XG4gICAgY29uc3Qgc2hvdWxkU2VsZWN0ID0gdGhpcy5zZWxlY3Rpb25Nb2RlICE9PSBudWxsICYmXG4gICAgICAoIXRhcmdldC5oYXNDaGlsZHJlbiB8fFxuICAgICAgICAodGFyZ2V0Lmhhc0NoaWxkcmVuICYmXG4gICAgICAgICAgKHRoaXMuc2VsZWN0aW9uTW9kZSA9PT0gXCJjaGlsZHJlblwiIHx8IHRoaXMuc2VsZWN0aW9uTW9kZSA9PT0gXCJtdWx0aWNoaWxkcmVuXCIpKSk7XG4gICAgY29uc3Qgc2hvdWxkRGVzZWxlY3RBbGxDaGlsZHJlbiA9IHRoaXMuc2VsZWN0aW9uTW9kZSA9PT0gXCJtdWx0aWNoaWxkcmVuXCIgJiYgdGFyZ2V0Lmhhc0NoaWxkcmVuO1xuICAgIGNvbnN0IHNob3VsZE1vZGlmeVRvQ3VycmVudFNlbGVjdGlvbiA9ICFpc05vbmVTZWxlY3Rpb25Nb2RlICYmXG4gICAgICBldmVudC5kZXRhaWwubW9kaWZ5Q3VycmVudFNlbGVjdGlvbiAmJlxuICAgICAgKHRoaXMuc2VsZWN0aW9uTW9kZSA9PT0gXCJtdWx0aXBsZVwiIHx8IHRoaXMuc2VsZWN0aW9uTW9kZSA9PT0gXCJtdWx0aWNoaWxkcmVuXCIpO1xuICAgIGNvbnN0IHNob3VsZENsZWFyQ3VycmVudFNlbGVjdGlvbiA9ICFzaG91bGRNb2RpZnlUb0N1cnJlbnRTZWxlY3Rpb24gJiZcbiAgICAgICgoKHRoaXMuc2VsZWN0aW9uTW9kZSA9PT0gXCJzaW5nbGVcIiB8fCB0aGlzLnNlbGVjdGlvbk1vZGUgPT09IFwibXVsdGlwbGVcIikgJiZcbiAgICAgICAgY2hpbGRJdGVtcy5sZW5ndGggPD0gMCkgfHxcbiAgICAgICAgdGhpcy5zZWxlY3Rpb25Nb2RlID09PSBcImNoaWxkcmVuXCIgfHxcbiAgICAgICAgdGhpcy5zZWxlY3Rpb25Nb2RlID09PSBcIm11bHRpY2hpbGRyZW5cIik7XG4gICAgY29uc3Qgc2hvdWxkVXBkYXRlRXhwYW5kID0gW1wiY2hpbGRyZW5cIiwgXCJtdWx0aWNoaWxkcmVuXCJdLmluY2x1ZGVzKHRoaXMuc2VsZWN0aW9uTW9kZSkgfHxcbiAgICAgIChbXCJzaW5nbGVcIiwgXCJtdWx0aXBsZVwiXS5pbmNsdWRlcyh0aGlzLnNlbGVjdGlvbk1vZGUpICYmXG4gICAgICAgIHRhcmdldC5oYXNDaGlsZHJlbiAmJlxuICAgICAgICAhZXZlbnQuZGV0YWlsLmZvcmNlVG9nZ2xlKTtcbiAgICBpZiAoIXRoaXMuY2hpbGQpIHtcbiAgICAgIGNvbnN0IHRhcmdldEl0ZW1zID0gW107XG4gICAgICBpZiAoc2hvdWxkU2VsZWN0KSB7XG4gICAgICAgIHRhcmdldEl0ZW1zLnB1c2godGFyZ2V0KTtcbiAgICAgIH1cbiAgICAgIGlmIChzaG91bGRDbGVhckN1cnJlbnRTZWxlY3Rpb24pIHtcbiAgICAgICAgY29uc3Qgc2VsZWN0ZWRJdGVtcyA9IG5vZGVMaXN0VG9BcnJheSh0aGlzLmVsLnF1ZXJ5U2VsZWN0b3JBbGwoXCJjYWxjaXRlLXRyZWUtaXRlbVtzZWxlY3RlZF1cIikpO1xuICAgICAgICBzZWxlY3RlZEl0ZW1zLmZvckVhY2goKHRyZWVJdGVtKSA9PiB7XG4gICAgICAgICAgaWYgKCF0YXJnZXRJdGVtcy5pbmNsdWRlcyh0cmVlSXRlbSkpIHtcbiAgICAgICAgICAgIHRyZWVJdGVtLnNlbGVjdGVkID0gZmFsc2U7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIGlmIChzaG91bGRVcGRhdGVFeHBhbmQpIHtcbiAgICAgICAgaWYgKFtcInNpbmdsZVwiLCBcIm11bHRpcGxlXCJdLmluY2x1ZGVzKHRoaXMuc2VsZWN0aW9uTW9kZSkpIHtcbiAgICAgICAgICB0YXJnZXQuZXhwYW5kZWQgPSAhdGFyZ2V0LmV4cGFuZGVkO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKHRoaXMuc2VsZWN0aW9uTW9kZSA9PT0gXCJtdWx0aWNoaWxkcmVuXCIpIHtcbiAgICAgICAgICB0YXJnZXQuZXhwYW5kZWQgPSAhdGFyZ2V0LnNlbGVjdGVkO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKHRoaXMuc2VsZWN0aW9uTW9kZSA9PT0gXCJjaGlsZHJlblwiKSB7XG4gICAgICAgICAgdGFyZ2V0LmV4cGFuZGVkID0gdGFyZ2V0LnNlbGVjdGVkID8gIXRhcmdldC5leHBhbmRlZCA6IHRydWU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmIChzaG91bGREZXNlbGVjdEFsbENoaWxkcmVuKSB7XG4gICAgICAgIGNoaWxkSXRlbXMuZm9yRWFjaCgoaXRlbSkgPT4ge1xuICAgICAgICAgIGl0ZW0uc2VsZWN0ZWQgPSBmYWxzZTtcbiAgICAgICAgICBpZiAoaXRlbS5oYXNDaGlsZHJlbikge1xuICAgICAgICAgICAgaXRlbS5leHBhbmRlZCA9IGZhbHNlO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICBpZiAoc2hvdWxkTW9kaWZ5VG9DdXJyZW50U2VsZWN0aW9uKSB7XG4gICAgICAgIHdpbmRvdy5nZXRTZWxlY3Rpb24oKS5yZW1vdmVBbGxSYW5nZXMoKTtcbiAgICAgIH1cbiAgICAgIGlmICgoc2hvdWxkTW9kaWZ5VG9DdXJyZW50U2VsZWN0aW9uICYmIHRhcmdldC5zZWxlY3RlZCkgfHwgZXZlbnQuZGV0YWlsLmZvcmNlVG9nZ2xlKSB7XG4gICAgICAgIHRhcmdldEl0ZW1zLmZvckVhY2goKHRyZWVJdGVtKSA9PiB7XG4gICAgICAgICAgaWYgKCF0cmVlSXRlbS5kaXNhYmxlZCkge1xuICAgICAgICAgICAgdHJlZUl0ZW0uc2VsZWN0ZWQgPSBmYWxzZTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgZWxzZSBpZiAoIWlzTm9uZVNlbGVjdGlvbk1vZGUpIHtcbiAgICAgICAgdGFyZ2V0SXRlbXMuZm9yRWFjaCgodHJlZUl0ZW0pID0+IHtcbiAgICAgICAgICBpZiAoIXRyZWVJdGVtLmRpc2FibGVkKSB7XG4gICAgICAgICAgICB0cmVlSXRlbS5zZWxlY3RlZCA9IHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5zZWxlY3RlZEl0ZW1zID0gaXNOb25lU2VsZWN0aW9uTW9kZVxuICAgICAgPyBbdGFyZ2V0XVxuICAgICAgOiBub2RlTGlzdFRvQXJyYXkodGhpcy5lbC5xdWVyeVNlbGVjdG9yQWxsKFwiY2FsY2l0ZS10cmVlLWl0ZW1cIikpLmZpbHRlcigoaSkgPT4gaS5zZWxlY3RlZCk7XG4gICAgdGhpcy5jYWxjaXRlVHJlZVNlbGVjdC5lbWl0KCk7XG4gICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gIH1cbiAgdXBkYXRlQW5jZXN0b3JUcmVlKGV2ZW50KSB7XG4gICAgY29uc3QgaXRlbSA9IGV2ZW50LnRhcmdldDtcbiAgICBjb25zdCB1cGRhdGVJdGVtID0gZXZlbnQuZGV0YWlsLnVwZGF0ZUl0ZW07XG4gICAgaWYgKGl0ZW0uZGlzYWJsZWQgfHwgKGl0ZW0uaW5kZXRlcm1pbmF0ZSAmJiAhdXBkYXRlSXRlbSkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgYW5jZXN0b3JzID0gW107XG4gICAgbGV0IHBhcmVudCA9IGl0ZW0ucGFyZW50RWxlbWVudC5jbG9zZXN0KFwiY2FsY2l0ZS10cmVlLWl0ZW1cIik7XG4gICAgd2hpbGUgKHBhcmVudCkge1xuICAgICAgYW5jZXN0b3JzLnB1c2gocGFyZW50KTtcbiAgICAgIHBhcmVudCA9IHBhcmVudC5wYXJlbnRFbGVtZW50LmNsb3Nlc3QoXCJjYWxjaXRlLXRyZWUtaXRlbVwiKTtcbiAgICB9XG4gICAgY29uc3QgY2hpbGRJdGVtcyA9IEFycmF5LmZyb20oaXRlbS5xdWVyeVNlbGVjdG9yQWxsKFwiY2FsY2l0ZS10cmVlLWl0ZW06bm90KFtkaXNhYmxlZF0pXCIpKTtcbiAgICBjb25zdCBjaGlsZEl0ZW1zV2l0aE5vQ2hpbGRyZW4gPSBjaGlsZEl0ZW1zLmZpbHRlcigoY2hpbGQpID0+ICFjaGlsZC5oYXNDaGlsZHJlbik7XG4gICAgY29uc3QgY2hpbGRJdGVtc1dpdGhDaGlsZHJlbiA9IGNoaWxkSXRlbXMuZmlsdGVyKChjaGlsZCkgPT4gY2hpbGQuaGFzQ2hpbGRyZW4pO1xuICAgIGxldCBmdXR1cmVTZWxlY3RlZDtcbiAgICBpZiAodXBkYXRlSXRlbSkge1xuICAgICAgZnV0dXJlU2VsZWN0ZWQgPSBpdGVtLmhhc0NoaWxkcmVuID8gIShpdGVtLnNlbGVjdGVkIHx8IGl0ZW0uaW5kZXRlcm1pbmF0ZSkgOiAhaXRlbS5zZWxlY3RlZDtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICBmdXR1cmVTZWxlY3RlZCA9IGl0ZW0uc2VsZWN0ZWQ7XG4gICAgfVxuICAgIGNoaWxkSXRlbXNXaXRoTm9DaGlsZHJlbi5mb3JFYWNoKChlbCkgPT4ge1xuICAgICAgZWwuc2VsZWN0ZWQgPSBmdXR1cmVTZWxlY3RlZDtcbiAgICAgIGVsLmluZGV0ZXJtaW5hdGUgPSBmYWxzZTtcbiAgICB9KTtcbiAgICBmdW5jdGlvbiB1cGRhdGVJdGVtU3RhdGUoY2hpbGRJdGVtcywgaXRlbSkge1xuICAgICAgY29uc3Qgc2VsZWN0ZWQgPSBjaGlsZEl0ZW1zLmZpbHRlcigoY2hpbGQpID0+IGNoaWxkLnNlbGVjdGVkKTtcbiAgICAgIGNvbnN0IHVuc2VsZWN0ZWQgPSBjaGlsZEl0ZW1zLmZpbHRlcigoY2hpbGQpID0+ICFjaGlsZC5zZWxlY3RlZCk7XG4gICAgICBpdGVtLnNlbGVjdGVkID0gc2VsZWN0ZWQubGVuZ3RoID09PSBjaGlsZEl0ZW1zLmxlbmd0aDtcbiAgICAgIGl0ZW0uaW5kZXRlcm1pbmF0ZSA9IHNlbGVjdGVkLmxlbmd0aCA+IDAgJiYgdW5zZWxlY3RlZC5sZW5ndGggPiAwO1xuICAgIH1cbiAgICBjaGlsZEl0ZW1zV2l0aENoaWxkcmVuLnJldmVyc2UoKS5mb3JFYWNoKChlbCkgPT4ge1xuICAgICAgY29uc3QgZGlyZWN0Q2hpbGRJdGVtcyA9IEFycmF5LmZyb20oZWwucXVlcnlTZWxlY3RvckFsbChcIjpzY29wZSA+IGNhbGNpdGUtdHJlZSA+IGNhbGNpdGUtdHJlZS1pdGVtXCIpKTtcbiAgICAgIHVwZGF0ZUl0ZW1TdGF0ZShkaXJlY3RDaGlsZEl0ZW1zLCBlbCk7XG4gICAgfSk7XG4gICAgaWYgKHVwZGF0ZUl0ZW0pIHtcbiAgICAgIGlmIChpdGVtLmhhc0NoaWxkcmVuKSB7XG4gICAgICAgIHVwZGF0ZUl0ZW1TdGF0ZShjaGlsZEl0ZW1zLCBpdGVtKTtcbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICBpdGVtLnNlbGVjdGVkID0gZnV0dXJlU2VsZWN0ZWQ7XG4gICAgICAgIGl0ZW0uaW5kZXRlcm1pbmF0ZSA9IGZhbHNlO1xuICAgICAgfVxuICAgIH1cbiAgICBhbmNlc3RvcnMuZm9yRWFjaCgoYW5jZXN0b3IpID0+IHtcbiAgICAgIGNvbnN0IGRlc2NlbmRhbnRzID0gbm9kZUxpc3RUb0FycmF5KGFuY2VzdG9yLnF1ZXJ5U2VsZWN0b3JBbGwoXCJjYWxjaXRlLXRyZWUtaXRlbVwiKSk7XG4gICAgICBjb25zdCBhY3RpdmVEZXNjZW5kYW50cyA9IGRlc2NlbmRhbnRzLmZpbHRlcigoZWwpID0+IGVsLnNlbGVjdGVkKTtcbiAgICAgIGlmIChhY3RpdmVEZXNjZW5kYW50cy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgYW5jZXN0b3Iuc2VsZWN0ZWQgPSBmYWxzZTtcbiAgICAgICAgYW5jZXN0b3IuaW5kZXRlcm1pbmF0ZSA9IGZhbHNlO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBjb25zdCBpbmRldGVybWluYXRlID0gYWN0aXZlRGVzY2VuZGFudHMubGVuZ3RoIDwgZGVzY2VuZGFudHMubGVuZ3RoO1xuICAgICAgYW5jZXN0b3IuaW5kZXRlcm1pbmF0ZSA9IGluZGV0ZXJtaW5hdGU7XG4gICAgICBhbmNlc3Rvci5zZWxlY3RlZCA9ICFpbmRldGVybWluYXRlO1xuICAgIH0pO1xuICAgIHRoaXMuc2VsZWN0ZWRJdGVtcyA9IG5vZGVMaXN0VG9BcnJheSh0aGlzLmVsLnF1ZXJ5U2VsZWN0b3JBbGwoXCJjYWxjaXRlLXRyZWUtaXRlbVwiKSkuZmlsdGVyKChpKSA9PiBpLnNlbGVjdGVkKTtcbiAgICBpZiAodXBkYXRlSXRlbSkge1xuICAgICAgdGhpcy5jYWxjaXRlVHJlZVNlbGVjdC5lbWl0KCk7XG4gICAgfVxuICB9XG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vXG4gIC8vICBQcml2YXRlIE1ldGhvZHNcbiAgLy9cbiAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICBnZXRSb290VGFiSW5kZXgoKSB7XG4gICAgcmV0dXJuICF0aGlzLmNoaWxkID8gMCA6IC0xO1xuICB9XG4gIGdldCBlbCgpIHsgcmV0dXJuIHRoaXM7IH1cbiAgc3RhdGljIGdldCBzdHlsZSgpIHsgcmV0dXJuIHRyZWVDc3M7IH1cbn0sIFsxLCBcImNhbGNpdGUtdHJlZVwiLCB7XG4gICAgXCJsaW5lc1wiOiBbMTU0MF0sXG4gICAgXCJjaGlsZFwiOiBbMTU0MF0sXG4gICAgXCJzY2FsZVwiOiBbMTUzN10sXG4gICAgXCJzZWxlY3Rpb25Nb2RlXCI6IFsxNTM3LCBcInNlbGVjdGlvbi1tb2RlXCJdLFxuICAgIFwic2VsZWN0ZWRJdGVtc1wiOiBbMTA0MF1cbiAgfSwgW1swLCBcImZvY3VzXCIsIFwib25Gb2N1c1wiXSwgWzAsIFwiZm9jdXNpblwiLCBcIm9uRm9jdXNJblwiXSwgWzAsIFwiZm9jdXNvdXRcIiwgXCJvbkZvY3VzT3V0XCJdLCBbMCwgXCJjYWxjaXRlSW50ZXJuYWxUcmVlSXRlbVNlbGVjdFwiLCBcIm9uQ2xpY2tcIl1dXSk7XG5mdW5jdGlvbiBkZWZpbmVDdXN0b21FbGVtZW50JDEoKSB7XG4gIGlmICh0eXBlb2YgY3VzdG9tRWxlbWVudHMgPT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgY29uc3QgY29tcG9uZW50cyA9IFtcImNhbGNpdGUtdHJlZVwiXTtcbiAgY29tcG9uZW50cy5mb3JFYWNoKHRhZ05hbWUgPT4geyBzd2l0Y2ggKHRhZ05hbWUpIHtcbiAgICBjYXNlIFwiY2FsY2l0ZS10cmVlXCI6XG4gICAgICBpZiAoIWN1c3RvbUVsZW1lbnRzLmdldCh0YWdOYW1lKSkge1xuICAgICAgICBjdXN0b21FbGVtZW50cy5kZWZpbmUodGFnTmFtZSwgVHJlZSk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgfSB9KTtcbn1cbmRlZmluZUN1c3RvbUVsZW1lbnQkMSgpO1xuXG5jb25zdCBDYWxjaXRlVHJlZSA9IFRyZWU7XG5jb25zdCBkZWZpbmVDdXN0b21FbGVtZW50ID0gZGVmaW5lQ3VzdG9tRWxlbWVudCQxO1xuXG5leHBvcnQgeyBDYWxjaXRlVHJlZSwgZGVmaW5lQ3VzdG9tRWxlbWVudCB9O1xuIl0sIm5hbWVzIjpbXSwic291cmNlUm9vdCI6IiJ9